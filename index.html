<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neuraxon Network Builder By David Vivancos & Jose Sanchez From Artificiology Research, UNIR & Qubic Science</title>
  <style>
    :root {
      --base-size: clamp(12px, 1.1vw, 16px);
      --primary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --dark: #2c3e50;
      --light: #ecf0f1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      overflow: hidden;
    }

    #main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Configuration Panel */
    #config-panel {
      flex: 1;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.98);
      padding: 2em;
      transition: all 0.3s ease;
    }

    #config-panel.hidden {
      display: none;
    }

    /* Visualization Container */
    #viz-container {
      display: none;
      flex: 1;
      flex-direction: row;
      align-items: stretch;
      gap: 0;
    }

    #viz-container.visible {
      display: flex;
    }

    #canvas-container {
      flex: 1;
      position: relative;
      background: #000;
      min-width: 0;
    }

    #networkCanvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #controls {
      position: relative;
      flex: 0 1 350px;
      min-width: 250px;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.95);
      padding: 1.5em;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
    }

    /* Headers */
    h1 {
      color: var(--dark);
      font-size: 2em;
      margin-bottom: 0.5em;
      border-bottom: 3px solid var(--primary);
      padding-bottom: 0.3em;
    }

    h2 {
      color: var(--dark);
      font-size: 1.4em;
      margin-top: 1.2em;
      margin-bottom: 0.8em;
      padding-left: 0.5em;
      border-left: 4px solid var(--primary);
    }

    h3 {
      color: #34495e;
      font-size: 1.1em;
      margin-top: 0.8em;
      margin-bottom: 0.5em;
    }

    /* Parameter Sections */
    .param-section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5em;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .param-group {
      margin-bottom: 1.2em;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.4em;
      font-size: 0.95em;
    }

    .param-description {
      font-size: 0.85em;
      color: #7f8c8d;
      margin-bottom: 0.3em;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      margin: 0.5em 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .value-display {
      display: inline-block;
      min-width: 60px;
      padding: 0.3em 0.6em;
      background: var(--light);
      border-radius: 4px;
      color: var(--primary);
      font-weight: 700;
      text-align: center;
      font-size: 0.9em;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 1em;
    }

    .slider-container input[type="range"] {
      flex: 1;
    }

    /* Buttons */
    button {
      padding: 1em 2em;
      margin: 0.5em 0.5em 0.5em 0;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #2980b9; transform: translateY(-2px); }
    
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #229954; }
    
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #c0392b; }
    
    .btn-warning { background: var(--warning); color: #fff; }
    .btn-warning:hover { background: #d68910; }

    .btn-secondary { background: #95a5a6; color: #fff; }
    .btn-secondary:hover { background: #7f8c8d; }

    #build-network-btn {
      width: 100%;
      font-size: 1.2em;
      padding: 1.2em;
      margin-top: 2em;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-top: 1em;
    }

    /* Presets */
    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8em;
      margin-top: 1em;
    }

    .preset-btn {
      padding: 0.8em;
      font-size: 0.9em;
    }

    /* Info box */
    .info-box {
      background: #e8f4f8;
      border-left: 4px solid var(--primary);
      padding: 1em;
      margin: 1em 0;
      border-radius: 4px;
    }

    .info-box strong {
      color: var(--primary);
    }

    /* Loading overlay */
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #loading-overlay.visible {
      display: flex;
    }

    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: white;
      font-size: 1.2em;
      margin-top: 1em;
    }

    /* Info display in viz mode */
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-width: 320px;
      z-index: 2;
    }

    .legend {
      background: rgba(255, 255, 255, 0.9);
      padding: 1em;
      border-radius: 8px;
      margin-top: 1em;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 0.4em 0;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 0.6em;
      border-radius: 4px;
    }

    /* Input states */
    .input-states {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5em;
      margin: 0.8em 0;
    }

    .input-btn {
      padding: 0.8em;
      border-radius: 6px;
      border: 2px solid #34495e;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 600;
    }

    .input-btn.state-excitatory { background: #2ecc71; color: #fff; border-color: #27ae60; }
    .input-btn.state-inhibitory { background: #e74c3c; color: #fff; border-color: #c0392b; }
    .input-btn.state-neutral { background: #95a5a6; color: #fff; border-color: #7f8c8d; }

    .simulation-running { background: var(--success) !important; }

    @media (max-width: 900px) {
      #viz-container {
        flex-direction: column;
      }
      #canvas-container {
        height: 55vh;
      }
      #controls {
        flex: 0 0 auto;
        width: 100% !important;
        height: 45vh;
      }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <!-- Configuration Panel -->
    <div id="config-panel">
      <h1>üß† <a href="https://www.researchgate.net/publication/397331336_Neuraxon"> Neuraxon</a> Network Builder</h1><h2> By <a href="https://vivancos.com/">David Vivancos</a> & <a href="https://josesanchezgarcia.com/">Jose Sanchez</a> - <a href="https://qubic.org/">Qubic Science</a></h2>
      
      <div class="info-box">
        <strong>Build Your Bio-Inspired Neural Network based on Neuraxon paper & Qubic's Aigarth Intelligent Tissue</strong><br>
        Configure all parameters using the sliders below, then click "Build Network" to create and visualize your custom Neuraxon network with trinary states, continuous processing, and complex synaptic dynamics.
      </div>

      <div class="preset-buttons">
        <button class="btn-secondary preset-btn" onclick="loadPreset('default')">üìã Default</button>
        <button class="btn-secondary preset-btn" onclick="loadPreset('small')">üî¨ Small Network</button>
        <button class="btn-secondary preset-btn" onclick="loadPreset('large')">üåê Large Network</button>
        <button class="btn-secondary preset-btn" onclick="loadPreset('sparse')">üï∏Ô∏è Sparse</button>
        <button class="btn-secondary preset-btn" onclick="loadPreset('dense')">üï∑Ô∏è Dense</button>
        <button class="btn-secondary preset-btn" onclick="loadPreset('fast')">‚ö° Fast Dynamics</button>
      </div>

      <!-- Network Architecture -->
      <div class="param-section">
        <h2>üèóÔ∏è Network Architecture</h2>
        
        <div class="param-group">
          <label>Input Neurons</label>
          <div class="param-description">Number of input neurons (1-5)</div>
          <div class="slider-container">
            <input type="range" id="num_input_neurons" min="1" max="5" value="3" step="1">
            <span class="value-display" id="val-num_input_neurons">3</span>
          </div>
        </div>

        <div class="param-group">
          <label>Hidden Neurons</label>
          <div class="param-description">Number of hidden neurons (1-100)</div>
          <div class="slider-container">
            <input type="range" id="num_hidden_neurons" min="1" max="100" value="40" step="1">
            <span class="value-display" id="val-num_hidden_neurons">40</span>
          </div>
        </div>

        <div class="param-group">
          <label>Output Neurons</label>
          <div class="param-description">Number of output neurons (1-5)</div>
          <div class="slider-container">
            <input type="range" id="num_output_neurons" min="1" max="5" value="3" step="1">
            <span class="value-display" id="val-num_output_neurons">3</span>
          </div>
        </div>

        <div class="param-group">
          <label>Connection Probability</label>
          <div class="param-description">Probability of synapse formation between neurons (0.0-0.20)</div>
          <div class="slider-container">
            <input type="range" id="connection_probability" min="0" max="0.20" value="0.15" step="0.01">
            <span class="value-display" id="val-connection_probability">0.05</span>
          </div>
        </div>
      </div>

      <!-- Neuron Parameters -->
      <div class="param-section">
        <h2>‚ö° Neuron Parameters</h2>
        
        <div class="param-group">
          <label>Membrane Time Constant (ms)</label>
          <div class="param-description">Time constant for membrane potential decay (5.0-50.0)</div>
          <div class="slider-container">
            <input type="range" id="membrane_time_constant" min="5" max="50" value="20" step="0.5">
            <span class="value-display" id="val-membrane_time_constant">20.0</span>
          </div>
        </div>

        <div class="param-group">
          <label>Excitatory Threshold</label>
          <div class="param-description">Firing threshold for excitatory state (+1) (0.5-2.0)</div>
          <div class="slider-container">
            <input type="range" id="firing_threshold_excitatory" min="0.5" max="2" value="1" step="0.1">
            <span class="value-display" id="val-firing_threshold_excitatory">1.0</span>
          </div>
        </div>

        <div class="param-group">
          <label>Inhibitory Threshold</label>
          <div class="param-description">Firing threshold for inhibitory state (-1) (-2.0 to -0.5)</div>
          <div class="slider-container">
            <input type="range" id="firing_threshold_inhibitory" min="-2" max="-0.5" value="-1" step="0.1">
            <span class="value-display" id="val-firing_threshold_inhibitory">-1.0</span>
          </div>
        </div>

        <div class="param-group">
          <label>Adaptation Rate</label>
          <div class="param-description">Rate of neuronal adaptation (0.0-0.2)</div>
          <div class="slider-container">
            <input type="range" id="adaptation_rate" min="0" max="0.2" value="0.05" step="0.01">
            <span class="value-display" id="val-adaptation_rate">0.05</span>
          </div>
        </div>

        <div class="param-group">
          <label>Spontaneous Firing Rate</label>
          <div class="param-description">Probability of spontaneous activity (0.0-0.1)</div>
          <div class="slider-container">
            <input type="range" id="spontaneous_firing_rate" min="0" max="0.1" value="0.01" step="0.001">
            <span class="value-display" id="val-spontaneous_firing_rate">0.01</span>
          </div>
        </div>

        <div class="param-group">
          <label>Health Decay Rate</label>
          <div class="param-description">Rate of neuron health decay without activity (0.0-0.01)</div>
          <div class="slider-container">
            <input type="range" id="neuron_health_decay" min="0" max="0.01" value="0.001" step="0.0001">
            <span class="value-display" id="val-neuron_health_decay">0.001</span>
          </div>
        </div>
      </div>

      <!-- Synapse Parameters -->
      <div class="param-section">
        <h2>üîó Synapse Parameters</h2>
        
        <h3>Fast Ionotropic (AMPA-like)</h3>
        <div class="param-group">
          <label>Time Constant (ms)</label>
          <div class="slider-container">
            <input type="range" id="tau_fast" min="1" max="10" value="5" step="0.1">
            <span class="value-display" id="val-tau_fast">5.0</span>
          </div>
        </div>
        <div class="param-group">
          <label>Weight Min/Max</label>
          <div class="slider-container">
            <input type="range" id="w_fast_init_min" min="-1" max="0" value="-1" step="0.1">
            <span class="value-display" id="val-w_fast_init_min">-1.0</span>
          </div>
          <div class="slider-container">
            <input type="range" id="w_fast_init_max" min="0" max="1" value="1" step="0.1">
            <span class="value-display" id="val-w_fast_init_max">1.0</span>
          </div>
        </div>

        <h3>Slow Ionotropic (NMDA-like)</h3>
        <div class="param-group">
          <label>Time Constant (ms)</label>
          <div class="slider-container">
            <input type="range" id="tau_slow" min="20" max="100" value="50" step="1">
            <span class="value-display" id="val-tau_slow">50.0</span>
          </div>
        </div>
        <div class="param-group">
          <label>Weight Min/Max</label>
          <div class="slider-container">
            <input type="range" id="w_slow_init_min" min="-1" max="0" value="-0.5" step="0.1">
            <span class="value-display" id="val-w_slow_init_min">-0.5</span>
          </div>
          <div class="slider-container">
            <input type="range" id="w_slow_init_max" min="0" max="1" value="0.5" step="0.1">
            <span class="value-display" id="val-w_slow_init_max">0.5</span>
          </div>
        </div>

        <h3>Metabotropic</h3>
        <div class="param-group">
          <label>Time Constant (ms)</label>
          <div class="slider-container">
            <input type="range" id="tau_meta" min="500" max="5000" value="1000" step="100">
            <span class="value-display" id="val-tau_meta">1000.0</span>
          </div>
        </div>
        <div class="param-group">
          <label>Weight Min/Max</label>
          <div class="slider-container">
            <input type="range" id="w_meta_init_min" min="-0.5" max="0" value="-0.3" step="0.05">
            <span class="value-display" id="val-w_meta_init_min">-0.3</span>
          </div>
          <div class="slider-container">
            <input type="range" id="w_meta_init_max" min="0" max="0.5" value="0.3" step="0.05">
            <span class="value-display" id="val-w_meta_init_max">0.3</span>
          </div>
        </div>
      </div>

      <!-- Plasticity Parameters -->
      <div class="param-section">
        <h2>üå± Plasticity Parameters</h2>
        
        <div class="param-group">
          <label>Learning Rate</label>
          <div class="param-description">Synaptic plasticity learning rate (0.0-0.1)</div>
          <div class="slider-container">
            <input type="range" id="learning_rate" min="0" max="0.1" value="0.01" step="0.001">
            <span class="value-display" id="val-learning_rate">0.01</span>
          </div>
        </div>

        <div class="param-group">
          <label>STDP Window (ms)</label>
          <div class="param-description">Spike-timing-dependent plasticity window (10.0-50.0)</div>
          <div class="slider-container">
            <input type="range" id="stdp_window" min="10" max="50" value="20" step="1">
            <span class="value-display" id="val-stdp_window">20.0</span>
          </div>
        </div>

        <div class="param-group">
          <label>Synapse Integrity Threshold</label>
          <div class="param-description">Minimum integrity for synapse survival (0.0-0.5)</div>
          <div class="slider-container">
            <input type="range" id="synapse_integrity_threshold" min="0" max="0.5" value="0.1" step="0.05">
            <span class="value-display" id="val-synapse_integrity_threshold">0.1</span>
          </div>
        </div>

        <div class="param-group">
          <label>Synapse Formation Probability</label>
          <div class="param-description">Probability of new synapse formation (0.0-0.2)</div>
          <div class="slider-container">
            <input type="range" id="synapse_formation_prob" min="0" max="0.2" value="0.05" step="0.01">
            <span class="value-display" id="val-synapse_formation_prob">0.05</span>
          </div>
        </div>

        <div class="param-group">
          <label>Synapse Death Probability</label>
          <div class="param-description">Probability of synapse removal (0.0-0.1)</div>
          <div class="slider-container">
            <input type="range" id="synapse_death_prob" min="0" max="0.1" value="0.01" step="0.001">
            <span class="value-display" id="val-synapse_death_prob">0.01</span>
          </div>
        </div>

        <div class="param-group">
          <label>Neuron Death Threshold</label>
          <div class="param-description">Health threshold for neuron death (0.0-0.3)</div>
          <div class="slider-container">
            <input type="range" id="neuron_death_threshold" min="0" max="0.3" value="0.1" step="0.05">
            <span class="value-display" id="val-neuron_death_threshold">0.1</span>
          </div>
        </div>
      </div>

      <!-- Neuromodulator Parameters -->
      <div class="param-section">
        <h2>üß™ Neuromodulator Parameters</h2>
        
        <div class="param-group">
          <label>üéØ Dopamine Baseline</label>
          <div class="slider-container">
            <input type="range" id="dopamine_baseline" min="0" max="1" value="0.1" step="0.01">
            <span class="value-display" id="val-dopamine_baseline">0.1</span>
          </div>
        </div>

        <div class="param-group">
          <label>üòä Serotonin Baseline</label>
          <div class="slider-container">
            <input type="range" id="serotonin_baseline" min="0" max="1" value="0.1" step="0.01">
            <span class="value-display" id="val-serotonin_baseline">0.1</span>
          </div>
        </div>

        <div class="param-group">
          <label>üí° Acetylcholine Baseline</label>
          <div class="slider-container">
            <input type="range" id="acetylcholine_baseline" min="0" max="1" value="0.1" step="0.01">
            <span class="value-display" id="val-acetylcholine_baseline">0.1</span>
          </div>
        </div>

        <div class="param-group">
          <label>‚ö° Norepinephrine Baseline</label>
          <div class="slider-container">
            <input type="range" id="norepinephrine_baseline" min="0" max="1" value="0.1" step="0.01">
            <span class="value-display" id="val-norepinephrine_baseline">0.1</span>
          </div>
        </div>

        <div class="param-group">
          <label>Neuromodulator Decay Rate</label>
          <div class="param-description">Rate of neuromodulator decay (0.0-0.5)</div>
          <div class="slider-container">
            <input type="range" id="neuromod_decay_rate" min="0" max="0.5" value="0.1" step="0.01">
            <span class="value-display" id="val-neuromod_decay_rate">0.1</span>
          </div>
        </div>
      </div>

      <!-- Simulation Parameters -->
      <div class="param-section">
        <h2>‚è±Ô∏è Simulation Parameters</h2>
        
        <div class="param-group">
          <label>Time Step (dt) in ms</label>
          <div class="param-description">Simulation time step (0.1-10.0)</div>
          <div class="slider-container">
            <input type="range" id="dt" min="0.1" max="10" value="1" step="0.1">
            <span class="value-display" id="val-dt">1.0</span>
          </div>
        </div>

        <div class="param-group">
          <label>Simulation Steps</label>
          <div class="param-description">Number of initial simulation steps (1-10000)</div>
          <div class="slider-container">
            <input type="range" id="simulation_steps" min="1" max="10000" value="100" step="10">
            <span class="value-display" id="val-simulation_steps">100</span>
          </div>
        </div>
      </div>

      <button id="build-network-btn" class="btn-primary">
        üöÄ Build Neuraxon Network
      </button>
    </div>

    <!-- Visualization Container -->
    <div id="viz-container">
      <div id="canvas-container">
        <canvas id="networkCanvas"></canvas>
        <div id="info">
          <strong><a href="https://www.researchgate.net/publication/397331336_Neuraxon" style="color:#ffffff;" target="_blank"> Neuraxon</a> Network</strong><br />
          Neurons: <span id="neuron-count">0</span><br />
          Synapses: <span id="synapse-count">0</span><br />
          Modulators: <span id="modulator-count">0</span><br />
          Time: <span id="time">0</span> ms<br />
          Steps: <span id="steps">0</span>
        </div>
      </div>

      <div id="controls">
        <h1>üß† <a href="https://www.researchgate.net/publication/397331336_Neuraxon" style="color:#000000; target="_blank"> Neuraxon</a> Controls</h1>

        <button class="btn-secondary" style="width: 100%; margin-bottom: 1em;" onclick="backToConfig()">
          ‚¨ÖÔ∏è Back to Configuration
        </button>

        <h2>Input Neurons</h2>
        <div class="input-states" id="input-states"></div>

        <h2>Simulation</h2>
        <div class="param-group">
          <label>Simulation Steps:</label>
          <input type="number" id="sim-steps" value="100" min="1" max="10000" style="width: 100%; padding: 0.6em; border: 1px solid #ddd; border-radius: 4px;" />
        </div>
        <button class="btn-success" id="btn-simulate" style="width: 100%;">‚ñ∂ Run Simulation</button>
        <button class="btn-warning" id="btn-stop" style="width: 100%;">‚è∏ Stop</button>
        <button class="btn-danger" id="btn-reset" style="width: 100%;">üîÑ Reset Network</button>

        <h2>Neuromodulators</h2>
        <div class="param-group">
          <label><span>üéØ</span>Dopamine: <span class="value-display" id="val-dopamine-live">0.1</span></label>
          <input type="range" id="dopamine-live" min="0" max="1" step="0.01" value="0.1" />
        </div>
        <div class="param-group">
          <label><span>üòä</span>Serotonin: <span class="value-display" id="val-serotonin-live">0.1</span></label>
          <input type="range" id="serotonin-live" min="0" max="1" step="0.01" value="0.1" />
        </div>
        <div class="param-group">
          <label><span>üí°</span>Acetylcholine: <span class="value-display" id="val-acetylcholine-live">0.1</span></label>
          <input type="range" id="acetylcholine-live" min="0" max="1" step="0.01" value="0.1" />
        </div>
        <div class="param-group">
          <label><span>‚ö°</span>Norepinephrine: <span class="value-display" id="val-norepinephrine-live">0.1</span></label>
          <input type="range" id="norepinephrine-live" min="0" max="1" step="0.01" value="0.1" />
        </div>

        <div class="legend">
          <strong>Legend</strong>
          <div class="legend-item">
            <div class="legend-color" style="background: #3498db;"></div>
            <span>Input (Box)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #9b59b6;"></div>
            <span>Hidden (Sphere)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span>Output (Cone)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #2ecc71; height: 6px;"></div>
            <span>Excitatory Synapse</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c; height: 6px;"></div>
            <span>Inhibitory Synapse</span>
          </div>
          <div class="legend-item">
            <span style="font-size: 1.2em; margin-right: 0.5em;">üéØüòäüí°‚ö°</span>
            <span>Neuromodulators (moving along synapses)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">Building Neuraxon Network...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // Parameter configuration
    const paramIds = [
      'num_input_neurons', 'num_hidden_neurons', 'num_output_neurons', 'connection_probability',
      'membrane_time_constant', 'firing_threshold_excitatory', 'firing_threshold_inhibitory',
      'adaptation_rate', 'spontaneous_firing_rate', 'neuron_health_decay',
      'tau_fast', 'w_fast_init_min', 'w_fast_init_max',
      'tau_slow', 'w_slow_init_min', 'w_slow_init_max',
      'tau_meta', 'w_meta_init_min', 'w_meta_init_max',
      'learning_rate', 'stdp_window', 'synapse_integrity_threshold',
      'synapse_formation_prob', 'synapse_death_prob', 'neuron_death_threshold',
      'dopamine_baseline', 'serotonin_baseline', 'acetylcholine_baseline',
      'norepinephrine_baseline', 'neuromod_decay_rate',
      'dt', 'simulation_steps'
    ];

    // Setup slider listeners
    paramIds.forEach(id => {
      const slider = document.getElementById(id);
      const display = document.getElementById(`val-${id}`);
      slider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        display.textContent = value.toFixed(slider.step.includes('.') ? 
          (slider.step.split('.')[1].length) : 0);
      });
    });

    // Preset configurations
    const presets = {
      default: {
        num_input_neurons: 5, num_hidden_neurons: 20, num_output_neurons: 5,
        connection_probability: 0.05, membrane_time_constant: 20,
        firing_threshold_excitatory: 1, firing_threshold_inhibitory: -1
      },
      small: {
        num_input_neurons: 3, num_hidden_neurons: 10, num_output_neurons: 3,
        connection_probability: 0.08
      },
      large: {
        num_input_neurons: 10, num_hidden_neurons: 100, num_output_neurons: 10,
        connection_probability: 0.03
      },
      sparse: {
        connection_probability: 0.02, synapse_formation_prob: 0.02
      },
      dense: {
        connection_probability: 0.15, synapse_formation_prob: 0.1
      },
      fast: {
        tau_fast: 2, tau_slow: 25, tau_meta: 500,
        membrane_time_constant: 10, dt: 0.5
      }
    };

    function loadPreset(name) {
      const preset = presets[name];
      Object.entries(preset).forEach(([key, value]) => {
        const slider = document.getElementById(key);
        if (slider) {
          slider.value = value;
          slider.dispatchEvent(new Event('input'));
        }
      });
    }

    function getParameters() {
      const params = {};
      paramIds.forEach(id => {
        const slider = document.getElementById(id);
        params[id] = parseFloat(slider.value);
      });
      return params;
    }

    // Network data
    let networkData = null;
    let neuronMeshes = {};
    let synapseMeshes = [];
    let modulators = [];
    let isSimulating = false;
    let simulationInterval = null;

    // Three.js setup (will be initialized when network is built)
    let scene, camera, renderer, orbit, networkGroup;

    function buildNetwork() {
      const params = getParameters();
      
      // Show loading
      document.getElementById('loading-overlay').classList.add('visible');

      // Simulate network building (in real implementation, this would call Python backend)
      setTimeout(() => {
        // Generate mock network data
        networkData = generateMockNetwork(params);
        
        // Hide config, show viz
        document.getElementById('config-panel').classList.add('hidden');
        document.getElementById('viz-container').classList.add('visible');
        document.getElementById('loading-overlay').classList.remove('visible');

        // Initialize Three.js and visualization
        initThreeJS();
        initVisualization();
      }, 1000);
    }

    function generateMockNetwork(params) {
      // Generate a mock network structure based on parameters
      const neurons = {
        input: [],
        hidden: [],
        output: []
      };

      let id = 0;
      
      // Create neurons
      for (let i = 0; i < params.num_input_neurons; i++) {
        neurons.input.push({
          id: id++,
          type: 'input',
          trinary_state: 0,
          membrane_potential: 0,
          health: 1.0,
          is_active: true
        });
      }

      for (let i = 0; i < params.num_hidden_neurons; i++) {
        neurons.hidden.push({
          id: id++,
          type: 'hidden',
          trinary_state: 0,
          membrane_potential: 0,
          health: 1.0,
          is_active: true
        });
      }

      for (let i = 0; i < params.num_output_neurons; i++) {
        neurons.output.push({
          id: id++,
          type: 'output',
          trinary_state: 0,
          membrane_potential: 0,
          health: 1.0,
          is_active: true
        });
      }

      // Create synapses
      const synapses = [];
      const allNeurons = [...neurons.input, ...neurons.hidden, ...neurons.output];
      
      allNeurons.forEach(pre => {
        allNeurons.forEach(post => {
          if (pre.id !== post.id && Math.random() < params.connection_probability) {
            // Skip output to input connections
            if (pre.type === 'output' && post.type === 'input') return;
            
            synapses.push({
              pre_id: pre.id,
              post_id: post.id,
              w_fast: (Math.random() - 0.5) * 2,
              w_slow: (Math.random() - 0.5),
              w_meta: (Math.random() - 0.5) * 0.6,
              is_silent: Math.random() < 0.1,
              is_modulatory: Math.random() < 0.2,
              integrity: 1.0,
              synapse_type: 'ionotropic_fast'
            });
          }
        });
      });

      return {
        parameters: params,
        neurons: neurons,
        synapses: synapses,
        neuromodulators: {
          dopamine: params.dopamine_baseline,
          serotonin: params.serotonin_baseline,
          acetylcholine: params.acetylcholine_baseline,
          norepinephrine: params.norepinephrine_baseline
        },
        time: 0,
        step_count: 0
      };
    }

    function initThreeJS() {
      const canvas = document.getElementById('networkCanvas');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(
        75,
        canvas.clientWidth / canvas.clientHeight,
        0.1, 1000
      );
      camera.position.set(0, 10, 80);

      renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      orbit = new THREE.OrbitControls(camera, renderer.domElement);
      orbit.target.set(0, 0, 0);
      orbit.enableDamping = true;
      orbit.dampingFactor = 0.08;
      orbit.update();

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
      dirLight.position.set(20, 30, 20);
      scene.add(dirLight);

      networkGroup = new THREE.Group();
      scene.add(networkGroup);

      // Create emoji textures for neuromodulators
      createEmojiTextures();

      // Start animation loop
      animate(performance.now());
    }

    // [Include all the visualization functions from the original CreateHTML here]
    // For brevity, I'll include key functions:

    function createNeuronMesh(neuron) {
      let geometry, colorHex, scale = 1.0;

      if (neuron.type === 'input') {
        geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
        colorHex = 0x3498db;
        scale = 1.2;
      } else if (neuron.type === 'output') {
        geometry = new THREE.ConeGeometry(0.9, 2.2, 12);
        colorHex = 0xe74c3c;
        scale = 1.2;
      } else {
        geometry = new THREE.SphereGeometry(0.95, 20, 20);
        colorHex = 0x9b59b6;
      }

      const baseColor = new THREE.Color(colorHex);
      const material = new THREE.MeshPhongMaterial({
        color: baseColor.clone(),
        emissive: baseColor.clone(),
        emissiveIntensity: 0.2,
        transparent: true,
        opacity: 0.95
      });

      const mesh = new THREE.Mesh(geometry, material);
      mesh.scale.set(scale, scale, scale);
      mesh.userData = { id: neuron.id, neuronRef: neuron, baseColor };
      return mesh;
    }

    function layoutNeuronsSphere() {
      const allNeurons = [...networkData.neurons.input, ...networkData.neurons.hidden, ...networkData.neurons.output];
      const radius = 22;
      const n = allNeurons.length || 1;
      const golden = Math.PI * (3 - Math.sqrt(5));

      allNeurons.forEach((neuron, i) => {
        const y = 1 - (i / Math.max(1, (n - 1))) * 2;
        const r = Math.sqrt(Math.max(0, 1 - y * y));
        const theta = golden * i;
        const x = Math.cos(theta) * r;
        const z = Math.sin(theta) * r;

        const mesh = createNeuronMesh(neuron);
        mesh.position.set(x * radius, y * radius, z * radius);
        networkGroup.add(mesh);
        neuronMeshes[neuron.id] = mesh;
      });
    }

    function makeDendriteCurve(start, end) {
      const dir = new THREE.Vector3().subVectors(end, start);
      const len = Math.max(0.001, dir.length());
      const dirN = dir.clone().normalize();

      let up = new THREE.Vector3(0, 1, 0);
      if (Math.abs(dirN.dot(up)) > 0.95) up = new THREE.Vector3(1, 0, 0);
      const normal = new THREE.Vector3().crossVectors(up, dirN).normalize();
      const binorm = new THREE.Vector3().crossVectors(dirN, normal).normalize();

      const amp = len * 0.18;
      const p1 = start.clone().add(dirN.clone().multiplyScalar(len * 0.25)).add(normal.clone().multiplyScalar((Math.random()-0.5)*amp));
      const p2 = start.clone().add(dirN.clone().multiplyScalar(len * 0.75)).add(binorm.clone().multiplyScalar((Math.random()-0.5)*amp));

      return new THREE.CatmullRomCurve3([start.clone(), p1, p2, end.clone()]);
    }

    function createCurvedSynapse(synapse) {
      const pre = neuronMeshes[synapse.pre_id];
      const post = neuronMeshes[synapse.post_id];
      if (!pre || !post) return;

      const totalWeight = (synapse.w_fast || 0) + (synapse.w_slow || 0);
      const colorHex = totalWeight > 0 ? 0x2ecc71 : (totalWeight < 0 ? 0xe74c3c : 0x95a5a6);
      const radius = 0.02 + 0.08 * Math.min(Math.abs(totalWeight), 1.0);

      const curve = makeDendriteCurve(pre.position, post.position);
      const tubeGeo = new THREE.TubeGeometry(curve, 40, radius, 8, false);
      const tubeMat = new THREE.MeshPhongMaterial({ 
        color: colorHex, 
        transparent: true, 
        opacity: 0.9, 
        emissive: new THREE.Color(colorHex), 
        emissiveIntensity: 0.3 
      });
      const tube = new THREE.Mesh(tubeGeo, tubeMat);

      tube.userData = { synapse, curve };
      networkGroup.add(tube);
      synapseMeshes.push(tube);
    }

    const DARK10 = new THREE.Color(0x0A0A0A);
    
    function updateNeuronVisual(mesh) {
      const n = mesh.userData.neuronRef;
      const base = mesh.userData.baseColor;
      const mat = mesh.material;

      let emissiveIntensity;
      if (n.trinary_state === 1) {
        mat.color.copy(base);
        mat.emissive.copy(base);
        emissiveIntensity = 0.95;
      } else if (n.trinary_state === -1) {
        mat.color.copy(base).multiplyScalar(0.55);
        mat.emissive.copy(base);
        emissiveIntensity = 0.45;
      } else {
        mat.color.copy(DARK10);
        mat.emissive.copy(DARK10);
        emissiveIntensity = 0.06;
      }
      mat.emissiveIntensity = n.is_active ? emissiveIntensity : Math.min(emissiveIntensity, 0.02);
      mat.opacity = n.is_active ? 0.92 : 0.25;
      mat.needsUpdate = true;
    }

    function updateVisualization() {
      Object.values(neuronMeshes).forEach(updateNeuronVisual);
      document.getElementById('neuron-count').textContent = Object.keys(neuronMeshes).length;
      document.getElementById('synapse-count').textContent = synapseMeshes.length;
      document.getElementById('modulator-count').textContent = modulators.length;
      document.getElementById('time').textContent = networkData.time.toFixed(1);
      document.getElementById('steps').textContent = networkData.step_count;
    }

    function initVisualization() {
      layoutNeuronsSphere();
      networkData.synapses.forEach(createCurvedSynapse);
      updateVisualization();
      createInputControls();
      setupLiveControls();
      
      // Start spawning neuromodulator particles
      startModulatorSpawning();
    }

    function createInputControls() {
      const container = document.getElementById('input-states');
      container.innerHTML = '';
      networkData.neurons.input.forEach((neuron, index) => {
        const btn = document.createElement('button');
        btn.className = 'input-btn';
        btn.textContent = `IN${index}`;
        btn.dataset.neuronId = neuron.id;
        btn.dataset.state = neuron.trinary_state;
        styleInputButton(btn, neuron.trinary_state);
        btn.onclick = () => {
          let newState = (parseInt(btn.dataset.state) + 2) % 3 - 1;
          btn.dataset.state = newState;
          neuron.trinary_state = newState;
          styleInputButton(btn, newState);
          if (neuronMeshes[neuron.id]) updateNeuronVisual(neuronMeshes[neuron.id]);
        };
        container.appendChild(btn);
      });
    }

    function styleInputButton(btn, state) {
      btn.classList.remove('state-excitatory', 'state-inhibitory', 'state-neutral');
      if (state === 1) {
        btn.classList.add('state-excitatory');
        btn.textContent = btn.textContent.split(' ')[0] + ' +1';
      } else if (state === -1) {
        btn.classList.add('state-inhibitory');
        btn.textContent = btn.textContent.split(' ')[0] + ' -1';
      } else {
        btn.classList.add('state-neutral');
        btn.textContent = btn.textContent.split(' ')[0] + ' 0';
      }
    }

    function setupLiveControls() {
      // Neuromodulator controls
      ['dopamine', 'serotonin', 'acetylcholine', 'norepinephrine'].forEach(mod => {
        const slider = document.getElementById(`${mod}-live`);
        const display = document.getElementById(`val-${mod}-live`);
        slider.value = networkData.neuromodulators[mod];
        display.textContent = slider.value;
        
        slider.addEventListener('input', e => {
          const value = parseFloat(e.target.value);
          display.textContent = value.toFixed(2);
          networkData.neuromodulators[mod] = value;
        });
      });

      // Simulation controls
      document.getElementById('btn-simulate').addEventListener('click', () => {
        if (isSimulating) return;
        isSimulating = true;
        const btn = document.getElementById('btn-simulate');
        btn.classList.add('simulation-running');
        btn.textContent = '‚èµ Simulating...';
        const steps = parseInt(document.getElementById('sim-steps').value, 10);
        let currentStep = 0;
        simulationInterval = setInterval(() => {
          simulateStep();
          if (++currentStep >= steps) document.getElementById('btn-stop').click();
        }, 120);
      });

      document.getElementById('btn-stop').addEventListener('click', () => {
        if (simulationInterval) clearInterval(simulationInterval);
        simulationInterval = null;
        isSimulating = false;
        const btn = document.getElementById('btn-simulate');
        btn.classList.remove('simulation-running');
        btn.textContent = '‚ñ∂ Run Simulation';
      });

      document.getElementById('btn-reset').addEventListener('click', () => {
        document.getElementById('btn-stop').click();
        Object.values(networkData.neurons).flat().forEach(n => {
          n.trinary_state = 0;
          n.membrane_potential = 0;
        });
        networkData.time = 0;
        networkData.step_count = 0;
        updateVisualization();
        createInputControls();
      });
    }

    // Neuromodulator Emoji Particles
    const MOD_EMOJI = { 
      dopamine: 'üéØ', 
      serotonin: 'üòä', 
      acetylcholine: 'üí°', 
      norepinephrine: '‚ö°' 
    };
    
    const emojiTextures = {};
    
    function createEmojiTextures() {
      Object.entries(MOD_EMOJI).forEach(([key, emoji]) => {
        const cnv = document.createElement('canvas');
        cnv.width = 64;
        cnv.height = 64;
        const ctx = cnv.getContext('2d');
        ctx.font = '48px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(emoji, 32, 32);
        emojiTextures[key] = new THREE.CanvasTexture(cnv);
      });
    }

    function spawnModulators() {
      Object.entries(networkData.neuromodulators).forEach(([key, level]) => {
        const count = 1 + Math.floor(level * 3 + Math.random() * 2);
        for (let i = 0; i < count; i++) {
          if (synapseMeshes.length === 0) break;
          const s = synapseMeshes[Math.floor(Math.random() * synapseMeshes.length)];
          if (!s.userData.curve) continue;
          
          const sprite = new THREE.Sprite(
            new THREE.SpriteMaterial({ 
              map: emojiTextures[key], 
              transparent: true, 
              opacity: 0.95 
            })
          );
          sprite.scale.set(1.5, 1.5, 1.5);
          networkGroup.add(sprite);
          
          modulators.push({ 
            sprite, 
            curve: s.userData.curve, 
            progress: Math.random() * 0.4, 
            speed: 0.005 + 0.02 * level + Math.random() * 0.005 
          });
        }
      });
    }

    function updateModulators(deltaMs) {
      const toRemove = [];
      modulators.forEach((m, idx) => {
        m.progress += m.speed * (deltaMs / 16.67);
        if (m.progress >= 1) {
          toRemove.push(idx);
        } else {
          m.sprite.position.copy(m.curve.getPoint(m.progress));
        }
      });
      
      // Remove completed modulators
      for (let i = toRemove.length - 1; i >= 0; i--) {
        const idx = toRemove[i];
        networkGroup.remove(modulators[idx].sprite);
        modulators[idx].sprite.material.dispose();
        modulators.splice(idx, 1);
      }
    }

    function simulateStep() {
      // Simple mock simulation
      Object.values(networkData.neurons).flat().forEach(n => {
        if (n.type !== 'input' && Math.random() < 0.12) {
          n.trinary_state = Math.floor(Math.random() * 3) - 1;
        }
      });
      networkData.step_count++;
      networkData.time += networkData.parameters.dt;
      
      // Spawn neuromodulator particles
      spawnModulators();
      
      updateVisualization();
    }

    let lastTs = performance.now();
    
    function animate(ts) {
      requestAnimationFrame(animate);
      const delta = ts - lastTs;
      lastTs = ts;
      
      if (networkGroup) {
        networkGroup.rotation.y += 0.0004;
      }
      
      // Update neuromodulator particles
      updateModulators(delta);
      
      orbit.update();
      
      const canvas = document.getElementById('networkCanvas');
      const rect = canvas.getBoundingClientRect();
      const width = Math.max(1, Math.floor(rect.width));
      const height = Math.max(1, Math.floor(rect.height));
      
      if (canvas.width !== width || canvas.height !== height) {
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height, false);
      }
      
      renderer.render(scene, camera);
    }

    function backToConfig() {
      document.getElementById('viz-container').classList.remove('visible');
      document.getElementById('config-panel').classList.remove('hidden');
      
      // Stop simulation if running
      if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
        isSimulating = false;
      }
      
      // Clean up Three.js
      if (networkGroup) {
        while(networkGroup.children.length > 0) {
          networkGroup.remove(networkGroup.children[0]);
        }
      }
      
      // Clean up modulators
      modulators.forEach(m => {
        if (m.sprite && m.sprite.material) {
          m.sprite.material.dispose();
        }
      });
      modulators = [];
      
      neuronMeshes = {};
      synapseMeshes = [];
      networkData = null;
    }

    // Periodic modulator spawning (even when not simulating)
    let modulatorSpawnTimer = null;
    
    function startModulatorSpawning() {
      if (modulatorSpawnTimer) return;
      
      // Spawn initial batch
      spawnModulators();
      
      // Spawn periodically
      modulatorSpawnTimer = setInterval(() => {
        if (!isSimulating && networkData) {
          spawnModulators();
        }
      }, 2000);
    }
    
    function stopModulatorSpawning() {
      if (modulatorSpawnTimer) {
        clearInterval(modulatorSpawnTimer);
        modulatorSpawnTimer = null;
      }
    }

    // Build network button
    document.getElementById('build-network-btn').addEventListener('click', buildNetwork);

    // Handle window resize
    window.addEventListener('resize', () => {
      if (camera && renderer) {
        const canvas = document.getElementById('networkCanvas');
        const rect = canvas.getBoundingClientRect();
        camera.aspect = rect.width / rect.height;
        camera.updateProjectionMatrix();
        renderer.setSize(rect.width, rect.height, false);
      }
    });
  </script>
</body>
</html>